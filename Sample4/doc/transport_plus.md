# Над-транспортный уровень Transport+

Содержание

[TOC]

## Список терминов и обозначений

Используются следующие термины и обозначения:

- адрес узла - уникальный над-транспортный адрес узла, определенный в рамках над-транспортного уровня и состоящий из трех элементов: NodeID, ip и сокет;
- сокет - интернет сокет для подключения к узлу;
- Broadcast - алгоритм Partition-based Broadcast для сетей p2p на основе Chord;
- ip - интернет IP-адрес узла с поддержкой v4 и v6;
- fingers - таблица связей, содержащая перечень адресов узлов, наполнение таблицы определяется логикой LLChord;
- LLChord - алгоритм Low Latency Chord, улучшение классического алгоритма Chord;
- messageID - уникальный идентификатор сообщения, циркулирующего в p2p сети;
- NodeID - уникальный Chord идентификатор узла в p2p сети. Вычисляется, как результат хэш-функции SHA-1 от строки, состоящей из ip и socket, представленных в виде единой строки;
- p2p сеть - одноранговая сеть (от англ. "peer-to-peer");
- predecessor - адрес предыдущего узла в p2p сети, чей NodeID является численно-ближайшим меньшим к NodeID текущего узла;
- seed - список над-транспортных адресов узлов, корректно функционирующих в p2p сети;
- successor - адрес последующего узла в p2p сети, чей NodeID является численно-ближайшим большим к NodeID текущего узла;
- Transport+ - над-транспортный уровень.

## Назначение над-транспортного уровня

Над-транспортный уровень служит для организации сетевого взаимодействия между узлами одноранговой сети с минимальными задержками и широковещательной рассылкой в условиях ограниченных канальных ресурсов и динамически изменяющейся топологии сети.

## Общая характеристика

### Требования к над-транспортному уровню

Над-транспортный уровень соответствует следующим требованиям современных p2p сетей, а именно:

1. Простота реализации.
2. Простота расширения функционала.
3. Независимость узлов между собой.
4. Децентрализованная территориально распределенная сеть с независимыми между собой узлами.
5. В перспективе неограниченный размер сети. На сегодня – 2500 узлов.
6. Отсутствие выделенных серверов для балансировки информационных потоков.
7. Мерцающая сеть - непрерывно меняющееся количество узлов в сети.
8. Для подключения нового узла требуется знание любого существующего узла.
9. Ограниченный размер таблицы связей узлов между собой – невозможность хранить таблицу связей каждого с каждым в виду значительных накладных расходов на поддержание её актуальной для мерцающей сети.
10. Ограничение производительности и канальных ресурсов у узлов – узел не может единолично рассылать всем сообщения из-за неограниченного размера сети, неприемлемого роста очередей сообщений на отправку, поддерживается лишь ограниченное число интернет сокетов.
11. Доставка сообщений с минимальными задержками.
12. Поддержка гарантированной широковещательной рассылки, обеспечивающая доставку в условиях сбоев и отказов узлов и каналов связи.

### Общая структура над-транспортного уровня

В основе Transport+ лежат следующие алгоритмы:

* **Алгоритм LLChord с модификацией**. LLChord является развитием алгоритма Chord и полностью с ним совместим. LLChord предназначен для уменьшение задержек при пересылке сообщений или поиске узлов в p2p сети на основе Chord. Алгоритм Сhord описывает базовые принципы организации сетевого взаимодействия между узлами в децентрализованной p2p сети. Выполнена модификация LLChord, позволяющая напрямую пересылать сообщение удаленному узлу для уменьшения временных затрат на пересылку сообщений при поиске адресата в сети.
* **Алгоритм Partition-based broadcast (Broadcast) с модификацией**.  Broadcast предназначен для широковещательной рассылки сообщений по p2p сети на основе Chord с единичным посещением каждого узла.

На рис.1 представлены интерфейсы над-транспортного уровня для взаимодействия с уровнем приложения и транспортным уровнем.

![interfaces](..\doc\pic\layers.svg)

Рис.1 - Интерфейсы над-транспортного уровня

Над-транспортный уровень имеет следующие интерфейсы с вышележащим  уровнем приложения:

1. *Интерфейс данных*, отвечающий за передачу и прием данных.
2. *Конфигурационный интерфейс*, использующийся для управления над-транспортным уровнем путём изменения конфигурационных параметров.

Над-транспортный уровень для коммуникаций с нижележащим транспортным уровнем использует *интерфейс данных*, предназначенный для приема и передачи пакетов в транспортный уровень TCP/UDP.



### Машина состояний над-транспортного уровня

Работа Transport+ уровня в общем случае описывается Машиной состояний (МС), представленной в виде конечного детерминированного автомата, рис. 2.

![finite_state_machine](..\doc\pic\finite_state_machine.svg)

Рис. 2 - Машина состояний Transport+ уровня

Уровень одновременно может находиться только в одном из состояний.  Определены следующие состояния:

- LOAD - начальное состояние, загрузка конфигурационных параметров. 
- INIT - первичная настройка таблицы fingers и таблицы latency.
- JOIN - состояние подключения узла к p2p сети.
- IDLE - рабочее состояние ожидания;
- IN_DATA - состояние обработки сообщения данных, принятого из сети;
- SERVICE - состояние обработку служебных сообщений, использующихся для поддержания целостности p2p сети;
- UPDATE - установка precessor и обновление successor, таблицы fingers и таблицы latency;
- APP_REQUEST - состояние обработки запросов, поступивших от приложения или состояния UPDATE.

Общее описание действий каждого состояний приведено на рис.2.

#### LOAD

После включения Transport+ уровня узел находится в состоянии LOAD. В этом состоянии выполняется загрузка конфигурационных параметров. Таймеры и очереди сброшены, пусты.

#### INIT

В данном состоянии выполняется инициализация и заполнение таблиц связей fingers, successor, predecessor первым адресом узла из seed. Таблица временных задержек latency заполняется начальным значением 1 сек. 

#### JOIN

Состояние, в котором устанавливается successor и записи в таблице fingers и latency в количестве 2 штук. 

Отправляется в сеть сообщение c типом "`join`" (далее для краткости фраза "с типом" опускается и не используется).

Взводится таймер `t_join` на время, определенное в конфигурационном параметре `Trxjoin`.

Ожидается приход ответного сообщения `reply_find_successor`, содержащего адрес для successor c временной меткой. На основе временных меток вычисляется временная задержка между текущим  Transport+ уровнями текущего и удаленным узлом.

При отсутствии поступления ответных сообщений и истечения таймаута `Trxjoin` выполняется повторная отправка сообщения `join`.

При превышении количества повторных отправок более `Ctxjoin` раз сообщение `join` отправляется узлу, чей адрес указан следующим в списке seed. Если достигнут конец списка `seed`,  то берется первый адрес из `seed`, затем следующий по порядку и далее.

Отправляются два сообщения `find_successor` с id+1 и id+2, где id - собственный идентификатор узла. Каждый раз взводится таймер `t_fndsucc` на время, указанное в конфигурационном параметре `Tfindsucc`.

При отсутствии ответных сообщений `reply_find_successor` отправляется сообщение `join` на адрес узла, следующего из списка seed, и действия повторяются.

При корректном заполнении successor и таблицы fingers и latency не менее, чем на 2 записи, взводится таймер t_update на длительность, указанную в конфигурационном параметре Tupdate.

#### IDLE

В данном состоянии уровень Transport+ ожидает поступления данных или истечения таймера проверки актуальности (доступности) узлов t_update. Данными  являются: 1) входящие сообщения, поступающие из сети;  2) запросы, приходящие от вышерасположенного уровня приложения (далее - приложения). 

При поступлении входящего сообщения оно **проверяется на корректность**, а именно проверяется допустимость сочетания численных значений полей сообщения в зависимости от типа сообщения,  соответствие адреса получателя адресу текущего узла.

Также проверяется поступало ли такое сообщение ранее. Для этого каждое сообщение идентифицируется по временной метке и **подсчитывается количество получений** такого сообщения. Если количество превышает допустимое, определенное в конфигурационном параметре Crxduple в течение времени Trxduple, то сообщение отбрасывается.

#### IN_DATA

Состояние обработки информационного сообщения `single` или `broadcast`, принятого из p2p сети. Выполняются следующие действия:

1. Отправка подтверждения получения `ack`;
3. Передать данных из сообщения в приложению, если адресат сообщения соответствует собственному адресу узла;
4. При необходимости переслать сообщение далее по сети по логике LLChord или Broadcast с ожиданием подтверждения `ack` в течение таймаута Trxack.

#### SERVICE

Состояние обработки служебных сообщений, принятых из p2p сети.

Обрабатываются следующие сообщения:

- `join`

- `find_successor`

  

#### APP_REQUEST

Состояние обработки запроса, поступившего от приложения или из состояния HANDLE_MESSAGE. В зависимости от типа запроса выполняются различные действия, а именно:

- **req_hard_reset** - выполняется сброс очередей, таймеров, таблицы fingers и таблицы latency, переход в состояние LOAD;
- **req_soft_reset** - выполняется сброс таблицы fingers и таблицы latency, при этом сохраняются очереди и таймеры, переход в состояние INIT;
- **req_flush** - осуществляется сброс очередей, таймеров, при этом сохраняются таблица fingers и таблица latency, переход в состояние IDLE;
- **req_single** - формируется и отправляется сообщение `single_message`с ожиданием прихода подтверждения ack в течение таймаута Trxack;
- **req_broadcast** - формируется и отправляется сообщение `broadcast_message` с ожиданием прихода подтверждения ack в течение таймаута Trxack.



#### UPDATE

Состояние корректировки таблицы fingers, successor, predecessor и таблицы latency.

Обрабатываются следующие сообщения:

- `notify`

- `reply_find_successor`

  

### Таймеры

todo

### Конфигурационные параметры

В Transport+ используются конфигурационные параметры, представленные в таблице 1. Значения параметров должны быть определены до включения узла.

Таблица 1. Конфигурационные параметры уровня Transport+

| Параметр    | Назначение                                                   | Значение по умолчанию                  |
| ----------- | ------------------------------------------------------------ | -------------------------------------- |
| seed        | список над-транспортных адресов узлов, корректно функционирующих в p2p сети | требуется указать минимум 1 адрес узла |
| Trxjoin     | таймаут ожидания прихода сообщения reply_find_succesor в ответ на отправленное сообщение join | 20 сек                                 |
| Ctxjoin     | счетчик максимального количества повторных отправок сообщений join | 3                                      |
| Trxfindsucc | таймаут ожидания прихода сообщения reply_find_succesor в ответ на отправленное сообщение find_successor |                                        |
| Ctxfindsucc | счетчик максимального количества повторных отправок сообщений find_successor |                                        |
| Tupdate     | таймаут проверки актуальности записи адреса узла в таблице fingers, successor, predecessor и соответствующей им временной задержки в таблице latency | 5 сек                                  |
| Trxack      | таймаут ожидания прихода сообщения подтверждения ack         | 30 сек                                 |
| Сtxack      | счетчик максимального количества повторных отправок сообщений подтверждений ack |                                        |
| Trxduple    | Таймаут в течение, которого разрешено получать и обрабатывать дублированное сообщение | 25 сек                                 |
| Crxduple    | Счетчик максимального количества получения дублированных сообщений | 2                                      |
|             |                                                              |                                        |



### Типы сообщений

В Transport+ уровне определены и используются следующие типы сообщений.

Служебные сообщения:

- join;
- notify;
- find_successor;
- reply_find_successor;
- ack.

Информационные сообщения:

- single;
- multicast;
- broadcast.





### Форматы сообщений

**TODO** сообщение **find_successor** служит для ...

Состоит из следующих полей:

- dest - адрес узла назначения;
- source - адрес узла отправителя;
- initiator - адрес узла,  первоначально запустившего по сети запрос;
- type - тип запроса. Принимает значение "find_successor";
- данные - поле данных. Содержит искомый id узла;
- issued time - время создания запроса.



Сообщение **reply_find_successor**  служит для ...

Состоит из следующих полей:

- dest - адрес узла назначения;
- source - адрес узла отправителя;
- type - тип запроса. Принимает значение "reply_find_successor".
- данные - поле данных. Содержит адрес искомого узла в виде структуры под названием successor_address с полями: {ip, socket, id}
- issued time - время создания запроса



## Модель над-транспортного уровня

### Архитектура модели над-транспортного уровня

Укрупненная структурная схема модели p2p сети приведен на рис. 3.

![arch](..\doc\pic\p2p_arch.svg)

Рис. 3 - Укрупненная структурная схема модели p2p 

За функциональность Transport+ уровня отвечает модуль `Transport_plus` c подмодулем `low_latency_chord`, реализующего функциональность алгоритма Low Latency Chord.

Архитектура внутренних взаимосвязей Transport+ уровня в виде цепочки вызовов программных функций проиллюстрирована на рис. 4.

![arch](..\doc\pic\queues_actions.svg)

Рис. 4 - Архитектура внутренних взаимосвязей Transport+ уровня 	  




# Над-транспортный уровень Transport+

Содержание

[TOC]

## Список терминов и обозначений

Используются следующие термины и обозначения:

- адрес узла - уникальный над-транспортный адрес узла, определенный в рамках над-транспортного уровня и состоящий из трех элементов: NodeID, ip и сокет;
- сокет - интернет сокет для подключения к узлу;
- p2p сеть - одноранговая сеть (от англ. "peer-to-peer");
- ip - интернет IP-адрес узла с поддержкой v4 и v6;
- fingers - таблица связей, содержащая перечень адресов узлов по логике Сhord;
- successor - адрес последующего узла в p2p сети, чей NodeID является численно-ближайшим большим к NodeID текущего узла;
- predecessor - адрес предыдущего узла в p2p сети, чей NodeID является численно-ближайшим меньшим к NodeID текущего узла;
- NodeID - уникальный Chord идентификатор узла в p2p сети. Вычисляется, как результат хэш-функции SHA-1 от строки, состоящей из ip и socket, представленных в виде единой строки;
- seed - список над-транспортных адресов узлов, корректно функционирующих в p2p сети;
- Transport+ - над-транспортный уровень;
- LLChord - алгоритм Low Latency Chord, улучшение классического алгоритма Chord;
- Broadcast - алгоритм Partition-based Broadcast для сетей p2p на основе Chord .

## Назначение над-транспортного уровня

Над-транспортный уровень служит для организации сетевого взаимодействия между узлами одноранговой сети с минимальными задержками и широковещательной рассылкой в условиях ограниченных канальных ресурсов и динамически изменяющейся топологии сети.

## Общая характеристика

### Требования к над-транспортному уровню

Над-транспортный уровень соответствует следующим требованиям современных p2p сетей, а именно:

1. Простота реализации.
2. Простота расширения функционала.
3. Независимость узлов между собой.
4. Децентрализованная территориально распределенная сеть с независимыми между собой узлами.
5. В перспективе неограниченный размер сети. На сегодня – 2500 узлов.
6. Отсутствие выделенных серверов для балансировки информационных потоков.
7. Мерцающая сеть - непрерывно меняющееся количество узлов в сети.
8. Для подключения нового узла требуется знание любого существующего узла.
9. Ограниченный размер таблицы связей узлов между собой – невозможность хранить таблицу связей каждого с каждым в виду значительных накладных расходов на поддержание её актуальной для мерцающей сети.
10. Ограничение производительности и канальных ресурсов у узлов – узел не может единолично рассылать всем сообщения из-за неограниченного размера сети, неприемлемого роста очередей сообщений на отправку, поддерживается лишь ограниченное число интернет сокетов.
11. Доставка сообщений с минимальными задержками.
12. Поддержка гарантированной широковещательной рассылки, обеспечивающая доставку в условиях сбоев и отказов узлов и каналов связи.

### Общая структура над-транспортного уровня

В основе Transport+ лежат следующие алгоритмы:

* **Алгоритм LLChord с модификацией**. LLChord является развитием алгоритма Chord и полностью с ним совместим. LLChord предназначен для уменьшение задержек при пересылке сообщений или поиске узлов в p2p сети на основе Chord. Алгоритм Сhord описывает базовые принципы организации сетевого взаимодействия между узлами в децентрализованной p2p сети. Выполнена модификация LLChord, позволяющая напрямую пересылать сообщение удаленному узлу для уменьшения временных затрат на пересылку сообщений при поиске адресата в сети.
* **Алгоритм Partition-based broadcast (Broadcast) с модификацией**.  Broadcast предназначен для широковещательной рассылки сообщений по p2p сети на основе Chord с единичным посещением каждого узла.

На рис.1 представлены интерфейсы над-транспортного уровня для взаимодействия с уровнем приложений и канальным уровнем ПОБС.

![interfaces](..\doc\pic\interfaces.svg)

Рис.1 - Интерфейсы над-транспортного уровня

Над-транспортный уровень имеет следующие интерфейсы с вышележащим  уровнем приложений:

1. *Интерфейс данных*, отвечающий за передачу и прием данных.
2. *Конфигурационный интерфейс*, использующийся для управления над-транспортным уровнем путём изменения конфигурационных параметров.

Над-транспортный уровень для коммуникаций с нижележащим транспортным уровнем использует *интерфейс данных*, предназначенный для приема и передачи сообщений в транспортный уровень TCP/UDP.

### Машина состояний над-транспортного уровня

Работа Transport+ уровня в общем случае описывается конечным детерминированным автоматом, представленном на рис. 2.

![_chord_аlgo_v0.5](..\doc\pic\_chord_аlgo_v0.5.svg)

Рис. 2 - Машина состояний Transport+ уровня

Уровень одновременно может находиться только в одном из состояний.  Определены следующие состояния:

- INIT - начальное состояние и первичная настройка узла;
- IDLE - рабочее состояние ожидания;
- HANDLE_MESSAGE -  состояние обработки входящего сообщения, принятого из сети;
- HANDLE_REQUEST - состояние обработки принятых запросов;
- TRANSMIT - состояние передачи сообщения с проверкой доступности узлов;
- STABILIZE - состояние обновления, корректировки таблицы fingers, precessor, successor и таблицы latency.

Общее описание действий в каждом из состояний приведено на рис.2.

#### INIT

В данном состоянии выполняется инициализация и заполнение таблиц связей fingers, successor, predecessor первым адресом узла из seed. Таблица временных задержек latency заполняется L~init~. Задержка отсчитывается между уровнями Transport+ текущего узла и Transport+ уровнем удаленного узла из таблицы fingers, successor. Для этого отправляется в сеть сообщение `join`. Взводится таймер на время, определенное в конфигурационном параметре T~init~. Затем ожидается приход серии ответных сообщений `reply_find_successor`, содержащих адреса для fingers, successor, predecessor и временные метки. На основе временных меток вычисляется временная задержка между текущим и удаленными узлами с уровнями Transport+. При отсутствии поступления ответных сообщений и истечения таймаута T~init~ выполняется повторная отправка сообщения join. При превышении количества повторных отправок более C~init~ раз сообщение join отправляется узлу, чей адрес указан следующим в списке seed. Если достигнут конец списка seed,  то берется первый адрес из seed и так далее.

#### IDLE 

В данном состоянии уровень Transport+ ожидает поступления данных для обработки или истечения таймера проверки доступности узлов. Данными для обработки являются: 1) входящие сообщения, поступающие из сети;  2) запросы, приходящие от вышерасположенного уровня приложения (далее - приложение). При наступлении 

#### HANDLE_MESSAGE

Состояние обработки сообщения, принятого из нижерасположенного транспортного уровня p2p сети .

#### HANDLE_REQUEST

Состояние обработки запроса, поступившего от приложения или из состояния HANDLE_MESSAGE.

#### TRANSMIT

Состояние отправки сообщения в сеть с проверкой доступности удаленного узла.

#### STABILIZE

Состояние корректировки таблицы fingers, successor, predecessor и таблицы latency.

### Конфигурационные параметры

В Transport+ используются конфигурационные параметры, представленные в таблице 1. Значения параметров должны быть определены до включения узла.

Таблица 1. Конфигурационные параметры уровня Transport+

| Параметр | Назначение                                                   | Значение по умолчанию |
| -------- | ------------------------------------------------------------ | --------------------- |
| seed     | список над-транспортных адресов узлов, корректно функционирующих в p2p сети | Минимум адрес узла    |
| L~init~  | значение по умолчанию временной задержки между узлами на Transport+ уровне | 0,001 сек             |
| T~init~  | таймаут ожидания прихода сообщений reply_find_succesor для fingers, successor, predeccessor | 20 сек                |
| C~init~  | счетчик максимального количества повторных отправок сообщений join | 3                     |
|          |                                                              |                       |
|          |                                                              |                       |
|          |                                                              |                       |
|          |                                                              |                       |
|          |                                                              |                       |
|          |                                                              |                       |
|          |                                                              |                       |



1. - .
2. - 
3. - ;
4. -  
5. счетчики повтора

Пример значений по умолчанию параметров:



### Форматы сообщений

**TODO** Запрос **find_successor** служит для ...

Запрос состоит из следующих полей:

- dest - адрес узла назначения;
- source - адрес узла отправителя;
- initiator - адрес узла,  первоначально запустившего по сети запрос;
- type - тип запроса. Принимает значение "find_successor";
- данные - поле данных. Содержит искомый id узла;
- issued time - время создания запроса.



Ответ **reply_find_successor**  служит для ...

Ответ состоит из следующих полей:

- dest - адрес узла назначения;
- source - адрес узла отправителя;
- type - тип запроса. Принимает значение "reply_find_successor".
- данные - поле данных. Содержит адрес искомого узла в виде структуры под названием successor_address с полями: {ip, socket, id}
- issued time - время создания запроса






​	    	  



